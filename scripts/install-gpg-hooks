#!/bin/bash
# Install GPG pre-commit hooks in existing git repositories
# This is useful for repos that were created before the git template was configured

set -e

echo "GPG Pre-commit Hook Installer"
echo "=============================="
echo ""
echo "This script will install the GPG cache check hook in git repositories."
echo ""
echo "⚠️  NOTE: If you're using the Quantivly dotfiles, you probably"
echo "    don't need this script! Global hooks are configured via"
echo "    core.hooksPath, so all repos get hooks automatically."
echo ""
echo "This script is only needed if you've disabled global hooks"
echo "or want hooks in specific repos only."
echo ""
read -p "Continue anyway? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Cancelled. Your global hooks are working!"
    exit 0
fi
echo ""

# Function to install hook in a repo
install_hook() {
    local repo_path="$1"
    local hook_source="$HOME/.local/share/git-templates/hooks/pre-commit"
    local hook_dest="$repo_path/.git/hooks/pre-commit"

    if [[ ! -d "$repo_path/.git" ]]; then
        echo "❌ Not a git repository: $repo_path"
        return 1
    fi

    # Check if hook already exists
    if [[ -f "$hook_dest" ]]; then
        # Check if it's our hook
        if grep -q "git-check-gpg-cache" "$hook_dest" 2>/dev/null; then
            echo "✓ Hook already installed: $repo_path"
            return 0
        else
            echo "⚠️  Hook exists but not ours: $repo_path"
            read -p "   Overwrite? (y/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo "   Skipped."
                return 0
            fi
        fi
    fi

    # Install the hook
    mkdir -p "$(dirname "$hook_dest")"
    cp "$hook_source" "$hook_dest"
    chmod +x "$hook_dest"
    echo "✓ Installed hook: $repo_path"
}

# If arguments provided, install in those directories
if [[ $# -gt 0 ]]; then
    for repo in "$@"; do
        install_hook "$repo"
    done
    exit 0
fi

# Otherwise, search for repos in common locations
echo "Searching for git repositories..."
echo ""

# Search in home directory (max depth 3 to avoid deep traversal)
repos=$(find ~ -maxdepth 3 -name .git -type d 2>/dev/null | sed 's|/.git$||')

if [[ -z "$repos" ]]; then
    echo "No git repositories found."
    exit 0
fi

echo "Found repositories:"
echo "$repos" | nl
echo ""

read -p "Install hooks in all found repositories? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    while IFS= read -r repo; do
        install_hook "$repo"
    done <<< "$repos"
else
    echo "Cancelled."
fi

echo ""
echo "Done! New repositories will automatically get the hook via git template."
