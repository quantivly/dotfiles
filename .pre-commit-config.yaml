# Pre-commit hooks for dotfiles repository
# Install: pre-commit install
# Run manually: pre-commit run --all-files
# Update hooks: pre-commit autoupdate

repos:
  # Standard pre-commit hooks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: check-yaml
        name: Check YAML syntax
      - id: end-of-file-fixer
        name: Fix end of files
      - id: trailing-whitespace
        name: Trim trailing whitespace
      - id: detect-private-key
        name: Detect private keys
        exclude: 'zsh/zshrc\.history'  # Contains pattern text, not actual keys
      - id: check-added-large-files
        args: ['--maxkb=500']
        name: Check for large files
      - id: check-merge-conflict
        name: Check for merge conflicts
      - id: check-case-conflict
        name: Check for case conflicts
      - id: mixed-line-ending
        name: Check line endings

  # Shell script linting
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.9.0.6
    hooks:
      - id: shellcheck
        name: Shellcheck
        # Common zsh-specific codes to exclude:
        # SC1071: ShellCheck only supports sh/bash/dash/ksh
        # SC1073: Couldn't parse this (zsh syntax)
        # SC1072: Expected end of double quoted string (zsh arrays)
        # SC2034: Variable appears unused (zsh uses many for configuration)
        # SC2296: Parameter expansion in zsh differs from bash
        args: ['-x', '-e', 'SC1071,SC1073,SC1072,SC2034,SC2296']
        # Only exclude: dotbot (git submodule), p10k.zsh (external theme), main zshrc (sources others)
        # Zsh modules ARE checked - add targeted '# shellcheck disable=SC####' comments as needed
        exclude: '(dotbot/|p10k\.zsh|^zshrc$)'

  # Secret detection with gitleaks
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.18.2
    hooks:
      - id: gitleaks
        name: Gitleaks (secret detection)
        description: Scan for hardcoded secrets, API keys, tokens, passwords

  # Shell script formatting (optional - uncomment if desired)
  # - repo: https://github.com/scop/pre-commit-shfmt
  #   rev: v3.7.0-1
  #   hooks:
  #     - id: shfmt
  #       args: ['-w', '-i', '4', '-ci']
  #       exclude: 'dotbot/'

  # Additional script checks
  - repo: https://github.com/jumanjihouse/pre-commit-hooks
    rev: 3.0.0
    hooks:
      - id: script-must-have-extension
        name: Check script extensions
        exclude: '^(install|scripts/test-|dotbot/|p10k\.zsh)'  # Allow specific files without extension

  # Security: Check for secrets patterns
  - repo: local
    hooks:
      - id: check-secrets-patterns
        name: Check for secret patterns
        entry: bash -c 'if grep -rn -E "(password|secret|token|api[_-]?key)\\s*=\\s*[\"'"'"'][^\"'"'"']{8,}" --include="*.sh" --include="*.bash" --include="*.zsh" --exclude-dir=".git" --exclude-dir="dotbot" . 2>/dev/null; then echo "Found potential secrets in files above"; exit 1; fi'
        language: system
        pass_filenames: false
        files: '\.(sh|bash|zsh)$'

      - id: check-history-ignore
        name: Verify HISTORY_IGNORE includes secrets
        entry: bash -c 'if [ -f zsh/zshrc.history ]; then patterns=("secret" "password" "token" "AWS_ACCESS_KEY" "BEGIN\*PRIVATE\*KEY"); missing=(); for p in "${patterns[@]}"; do if ! grep -q "\*$p\*" zsh/zshrc.history; then missing+=("$p"); fi; done; if [ ${#missing[@]} -gt 0 ]; then echo "HISTORY_IGNORE missing patterns - ${missing[*]}"; exit 1; fi; fi'
        language: system
        pass_filenames: false
        files: 'zsh/zshrc\.history$'

      - id: check-no-local-files
        name: Verify no .local files committed
        entry: bash -c 'if git ls-files | grep -E "\.local$" 2>/dev/null; then echo "Found .local files - these should not be committed"; exit 1; fi'
        language: system
        pass_filenames: false
