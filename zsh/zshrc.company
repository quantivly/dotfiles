# Quantivly-specific configuration
# This file contains work-related settings and company-specific utilities
#
# All Quantivly-specific functionality consolidated here for better
# version control, easier updates, and single source of truth.

# Warn about deprecated plugin (remove this block after 2026-03-01)
if [[ -d "${HOME}/.oh-my-zsh/custom/plugins/quantivly" ]]; then
  echo "⚠️  Deprecated: quantivly oh-my-zsh plugin detected" >&2
  echo "   Functionality now built into dotfiles (zshrc.company)" >&2
  echo "   Safe to remove: rm -rf ~/.oh-my-zsh/custom/plugins/quantivly" >&2
fi

#==============================================================================
# Environment Variables
#==============================================================================

# Quantivly development environment settings
# These can be overridden in ~/.zshrc.local for machine-specific values
export Q_MODE="${Q_MODE:-development}"
export Q_DEV_CODE_ROOT="${Q_DEV_CODE_ROOT:-${HOME}/platform}"
export Q_WORKSPACES_ROOT="${Q_WORKSPACES_ROOT:-${HOME}/workspaces}"
export Q_WORKSPACE_NAME="${Q_WORKSPACE_NAME:-test}"
export Q_TEST_WORKSPACE_NAME="${Q_TEST_WORKSPACE_NAME:-cicd}"

# Docker environment variables
# Use fallback IP if hostname -I fails (e.g., no network interfaces)
_ip_addr=$(hostname -I 2>/dev/null | awk '{print $1}')
export IP_ADDRESS="${_ip_addr:-127.0.0.1}"
export EXTRA_HOSTS="$(hostname):${IP_ADDRESS}"
unset _ip_addr

# Platform test environment variables (cached for fast startup)
# Reads from ~/.cache/quanticli-paths/ synchronously (sub-ms),
# background job refreshes cache on every shell start.
# Manual refresh: qcache-refresh
_qcache_dir="${HOME}/.cache/quanticli-paths"
if [[ -r "$_qcache_dir/data" ]]; then
  export TEST_BASELINE_DATA_DIR="$(<"$_qcache_dir/data")"
else
  export TEST_BASELINE_DATA_DIR=""
fi
if [[ -r "$_qcache_dir/test" ]]; then
  _test_path="$(<"$_qcache_dir/test")"
  export TEST_BASELINE_REF_DIR="${_test_path}/testing-box-baseline/"
else
  export TEST_BASELINE_REF_DIR=""
fi
unset _test_path _qcache_dir

#==============================================================================
# Quanticli Aliases and Functions
#==============================================================================

# Quanticli shortcuts
# Ensure q is not aliased to something else first
unalias q 2>/dev/null
alias q='quanticli'
alias qg='quanticli git'
alias qgs='quanticli git status'
alias qh='quanticli hub'
alias qp='quanticli path'

# qn - Change directory to quantivly submodule or stack directory
# Usage: qn <directory-name>
# Example: qn auto-conf, qn sdk, qn (goes to code root)
qn() {
  : '
    Function: qn
    Description: Changes directory to the specified Quantivly submodule or stack directory.
    Usage: qn <directory-name>
    Parameters:
      <directory-name> - The name of the Quantivly submodule or stack directory to change to (or a partial match).
    Example:
      qn auto-conf
      qn sdk
    Notes:
      - If multiple directories match the specified name, the first match is used.
      - If no directories match the specified name, the current directory is not changed.
      - If no name is provided, the current directory will be changed to the root of the Quantivly repository.
    '
  if command -v quanticli &>/dev/null; then
    cd $(quanticli path ${1-code})
  else
    echo "Error: quanticli not found in PATH" >&2
    return 1
  fi
}

#==============================================================================
# GitHub CLI Multi-Account Switching
#==============================================================================
# Automatically switches gh CLI identity when entering Quantivly work directories.
# Opt-in: only activates if ~/.config/gh-quantivly/ exists (created via:
#   GH_CONFIG_DIR=~/.config/gh-quantivly gh auth login)

if [[ -d "$HOME/.config/gh-quantivly" ]]; then
    # Cache tokens for GH_TOKEN override and GITHUB_PERSONAL_ACCESS_TOKEN.
    # Reads from ~/.cache/gh-token-cache/ synchronously (sub-ms),
    # background job refreshes cache on every shell start.
    # Manual refresh: gh-refresh-tokens
    # NOTE: Must use --user to get the correct per-user keyring entry;
    # gh auth token without --user returns a shared default that may be wrong.
    _gh_token_cache="${HOME}/.cache/gh-token-cache"
    if [[ -r "$_gh_token_cache/quantivly" ]]; then
        _CACHED_GH_QUANTIVLY_TOKEN="$(<"$_gh_token_cache/quantivly")"
    fi
    unset _gh_token_cache

    # Background refresh of GH token cache (non-blocking)
    if command -v gh &>/dev/null; then
        {
            _dir="${HOME}/.cache/gh-token-cache"
            mkdir -p "$_dir" && chmod 700 "$_dir"
            _user="$(GH_CONFIG_DIR="$HOME/.config/gh-quantivly" gh config get -h github.com user 2>/dev/null)"
            if [[ -n "$_user" ]]; then
                _token="$(GH_CONFIG_DIR="$HOME/.config/gh-quantivly" gh auth token --user "$_user" 2>/dev/null)"
                if [[ -n "$_token" ]]; then
                    printf '%s' "$_token" > "$_dir/quantivly"
                    chmod 600 "$_dir/quantivly"
                fi
            fi
        } &!
    fi

    _update_gh_config() {
        case "$PWD" in
            "$HOME"/quantivly/*|"$HOME"/quantivly|"${Q_DEV_CODE_ROOT}"/*|"${Q_DEV_CODE_ROOT}")
                export GH_CONFIG_DIR="$HOME/.config/gh-quantivly"
                if [[ -n "$_CACHED_GH_QUANTIVLY_TOKEN" ]]; then
                    export GH_TOKEN="$_CACHED_GH_QUANTIVLY_TOKEN"
                    export GITHUB_PERSONAL_ACCESS_TOKEN="$_CACHED_GH_QUANTIVLY_TOKEN"
                fi
                ;;
            *)
                unset GH_CONFIG_DIR
                if [[ -n "$_CACHED_PERSONAL_GH_TOKEN" ]]; then
                    export GH_TOKEN="$_CACHED_PERSONAL_GH_TOKEN"
                    export GITHUB_PERSONAL_ACCESS_TOKEN="$_CACHED_PERSONAL_GH_TOKEN"
                else
                    unset GH_TOKEN
                    unset GITHUB_PERSONAL_ACCESS_TOKEN
                fi
                ;;
        esac
    }
    autoload -U add-zsh-hook
    add-zsh-hook chpwd _update_gh_config
    _update_gh_config  # Run once at shell startup
fi

#==============================================================================
# Claude Code Multi-Account Switching
#==============================================================================
# Automatically switches Claude Code identity when entering Quantivly work directories.
# Opt-in: only activates if ~/.claude-quantivly/ exists (created via:
#   CLAUDE_CONFIG_DIR=~/.claude-quantivly claude)
# Personal account (default): ~/.claude/
# Work account (Quantivly): ~/.claude-quantivly/

if [[ -d "$HOME/.claude-quantivly" ]]; then
    _update_claude_config() {
        case "$PWD" in
            "$HOME"/quantivly/*|"$HOME"/quantivly|"${Q_DEV_CODE_ROOT}"/*|"${Q_DEV_CODE_ROOT}")
                export CLAUDE_CONFIG_DIR="$HOME/.claude-quantivly"
                ;;
            *)
                unset CLAUDE_CONFIG_DIR
                ;;
        esac
    }
    autoload -U add-zsh-hook
    add-zsh-hook chpwd _update_claude_config
    _update_claude_config  # Run once at shell startup
fi

#==============================================================================
# Git Aliases (Quantivly-specific)
#==============================================================================

alias grpo="git remote prune origin"

#==============================================================================
# Docker Utilities
#==============================================================================

# dsh - Open a bash shell in specified Docker container
# Usage: dsh <container_name>
# Example: dsh my_container
dsh() {
  : '
    Function: dsh
    Description: Opens a bash shell in the specified Docker container.
    Usage: dsh <container_name>
    Parameters:
      <container_name> - The name of the Docker container in which to open a bash shell.
    Example:
      dsh my_container
    Notes:
      - The container must be running.
    '
  if [[ -z "$1" ]]; then
    echo "Usage: dsh <container_name>" >&2
    return 1
  fi

  local container_id=$(docker ps -aqf "name=$1")
  if [[ -z "$container_id" ]]; then
    echo "Error: No running container found matching '$1'" >&2
    return 1
  fi

  docker exec -it "$container_id" bash
}

# Docker service aliases
alias dsls="docker service ls"
alias dslf="docker service logs -f --raw"

#==============================================================================
# Database Utilities (Platform-specific)
#==============================================================================

# Box database shortcuts (uses cached workspace path)
# Note: Workspace path is evaluated at shell startup - reload shell after switching workspaces
_qcache_dir="${HOME}/.cache/quanticli-paths"
if [[ -r "$_qcache_dir/workspace" ]]; then
  _box_workspace_path="$(<"$_qcache_dir/workspace")"
elif command -v quanticli &>/dev/null; then
  _box_workspace_path="${Q_WORKSPACES_ROOT}/${Q_WORKSPACE_NAME}"
fi
if [[ -n "$_box_workspace_path" ]]; then
  alias box-psql="$_box_workspace_path/configs/box/postgres/psql.sh -d box"
  alias box-purge='$_box_workspace_path/configs/box/postgres/psql.sh -d box -c "truncate examination, acquisition restart identity cascade;"'
fi
unset _box_workspace_path _qcache_dir

# Background refresh of quanticli path cache (non-blocking)
if command -v quanticli &>/dev/null; then
  {
    _dir="${HOME}/.cache/quanticli-paths"
    mkdir -p "$_dir"
    for _key in data test workspace; do
      _val=$(quanticli path "$_key" 2>/dev/null)
      [[ -n "$_val" ]] && printf '%s' "$_val" > "$_dir/$_key"
    done
  } &!
fi

# qcache-refresh - Force refresh of quanticli path cache and reload env vars
qcache-refresh() {
  if ! command -v quanticli &>/dev/null; then
    echo "Error: quanticli not found in PATH" >&2
    return 1
  fi
  local _dir="${HOME}/.cache/quanticli-paths"
  mkdir -p "$_dir"
  for _key in data test workspace; do
    local _val
    _val=$(quanticli path "$_key" 2>/dev/null)
    if [[ -n "$_val" ]]; then
      printf '%s' "$_val" > "$_dir/$_key"
      echo "Cached $_key: $_val"
    fi
  done
  # Reload the env vars
  export TEST_BASELINE_DATA_DIR="$(<"$_dir/data")"
  local _test_path="$(<"$_dir/test")"
  export TEST_BASELINE_REF_DIR="${_test_path}/testing-box-baseline/"
  echo "Environment variables updated."
}

# gh-refresh-tokens - Force refresh of GH token cache and reload env vars
gh-refresh-tokens() {
  if ! command -v gh &>/dev/null; then
    echo "Error: gh CLI not found in PATH" >&2
    return 1
  fi
  local _dir="${HOME}/.cache/gh-token-cache"
  mkdir -p "$_dir" && chmod 700 "$_dir"
  local _user
  _user="$(GH_CONFIG_DIR="$HOME/.config/gh-quantivly" gh config get -h github.com user 2>/dev/null)"
  if [[ -z "$_user" ]]; then
    echo "Error: Could not determine Quantivly GH username" >&2
    return 1
  fi
  local _token
  _token="$(GH_CONFIG_DIR="$HOME/.config/gh-quantivly" gh auth token --user "$_user" 2>/dev/null)"
  if [[ -n "$_token" ]]; then
    printf '%s' "$_token" > "$_dir/quantivly"
    chmod 600 "$_dir/quantivly"
    _CACHED_GH_QUANTIVLY_TOKEN="$_token"
    echo "Cached token for user: $_user"
    echo "Token refreshed. Run _update_gh_config or cd to apply."
  else
    echo "Error: Could not retrieve token for user $_user" >&2
    return 1
  fi
}
