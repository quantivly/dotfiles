# ============================================================================
# Tmux Configuration
# ============================================================================
# Beginner-friendly tmux setup with modern features
#
# Key Features:
# - Ctrl+s prefix (ergonomic, no ghost input)
# - Mouse support enabled (easier learning curve)
# - True color support (24-bit color)
# - Terminator-style navigation (Ctrl+Shift+Arrow, no prefix needed)
# - OSC 52 clipboard (works over SSH)
# - Dark theme status bar
#
# Quick Reference (most operations are prefix-free!):
#   Ctrl+Shift+E        Split vertically (no prefix!)
#   Ctrl+Shift+O        Split horizontally (no prefix!)
#   Ctrl+Shift+W        Close pane (no prefix!)
#   Ctrl+Shift+T        New window (no prefix!)
#   Ctrl+Shift+F        Thumbs: quick-copy hints (no prefix!)
#   Ctrl+Shift+Arrow    Navigate panes (no prefix!)
#   Ctrl+Alt+Arrow      Resize panes (no prefix!)
#   Alt+z               Zoom pane toggle (no prefix!)
#   Alt+PageUp          Scroll back (enters copy mode + page up)
#   Ctrl+PageUp/Down    Next/previous window (no prefix!)
#   Ctrl+Shift+PageUp/Down  Reorder windows (no prefix!)
#   Alt+o               Fuzzy file finder popup (no prefix!)
#   Alt+s               Fuzzy content search popup (no prefix!)
#   Alt+w               Session picker popup (no prefix!)
#   Alt+g               Lazygit popup (no prefix!)
#   Alt+1-9             Switch to window by number
#   Alt+h/j/k/l         Navigate panes (vim-style)
#   Ctrl+s v        Enter copy mode (vim visual)
#   Ctrl+s /        Search (enters copy mode + search)
#   Ctrl+s p        Paste buffer
#   Ctrl+s t        Popup terminal
#   Ctrl+s d        Detach session
#   Ctrl+s ?        Show all keybindings
#   Ctrl+s r        Reload config
#
# See: examples/tmux-workflows.md for comprehensive guide
# See: help tmux (in zsh) for quick reference
# ============================================================================

# ============================================================================
# General Settings
# ============================================================================

# Set prefix to Ctrl+s (ergonomic, no ghost input like Ctrl+Space)
# Requires NO_FLOW_CONTROL in zsh (already set in zshrc)
unbind C-b
set -g prefix C-s
bind C-s send-prefix

# Enable mouse support (click panes, drag borders, scroll)
set -g mouse on

# Increase scrollback buffer (default: 2000)
# Reduced from 50000 to 10000 for better performance (clearing, rendering)
# 10k lines is still ~500 screens of history - plenty for most workflows
set -g history-limit 10000

# Start window and pane numbering at 1 (not 0)
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# No delay for escape key press (improves vim responsiveness)
set -sg escape-time 0

# Aggressive resize (only constrain window size if smaller client is viewing)
setw -g aggressive-resize on

# Enable focus events (allows vim to respond to focus changes)
set -g focus-events on

# Unbind default Alt+n/p window navigation (we use Ctrl+PageUp/Down instead)
# These shadow shell readline bindings (Alt+n/p = history navigation with args)
unbind -n M-n
unbind -n M-p

# Extended keys support (enables Ctrl+Shift+letter bindings)
# Requires tmux 3.3+ and a kitty keyboard protocol terminal (Alacritty)
# Note: Alacritty typically sets TERM=xterm-256color, so we match both
set -s extended-keys on
set -as terminal-features 'xterm-256color:extkeys:hyperlinks'
set -as terminal-features 'alacritty:extkeys:hyperlinks'

# Show messages and pane indicators for 2 seconds (default 750ms/1000ms is too brief)
set -g display-time 2000
set -g display-panes-time 2000

# SSH agent socket persistence across reconnections
# Uses the ~/.ssh/ssh_auth_sock symlink maintained by zsh startup
# (see zsh/zshrc.conditionals.plugins) so new panes always get a working socket
set-environment -g SSH_AUTH_SOCK ~/.ssh/ssh_auth_sock

# Remove SSH_AUTH_SOCK from update-environment to prevent 'tmux attach'
# from overwriting our global setting with a potentially stale value
set -g update-environment "DISPLAY KRB5CCNAME SSH_ASKPASS SSH_AGENT_PID SSH_CONNECTION WINDOWID XAUTHORITY"

# ============================================================================
# Color Support (True Color / 24-bit)
# ============================================================================

# Set default terminal to support 256 colors
set -g default-terminal "tmux-256color"

# Enable true color (24-bit) support
# This works with modern terminals that support RGB colors
set -ga terminal-overrides ",*256col*:Tc"
set -ga terminal-overrides ",*:RGB"

# Enable additional terminal features
set -ga terminal-overrides ",*:Ms=\\E]52;%p1%s;%p2%s\\007"  # OSC 52 clipboard

# ============================================================================
# Clipboard Integration (OSC 52)
# ============================================================================

# Enable clipboard integration (works over SSH!)
set -g set-clipboard on

# Note: This integrates with the osc52() function in zsh/functions/core.sh
# You can copy text from tmux to your local clipboard even over SSH:
#   1. Enter copy mode: Ctrl+s v (or Ctrl+s [)
#   2. Select text with vim keybindings
#   3. Copy: y (automatically uses OSC 52)
#   4. Or use: echo "text" | osc52 (from shell)

# ============================================================================
# Key Bindings - Pane Management
# ============================================================================

# Split panes - Terminator-style (no prefix needed!)
# Requires Alacritty key bindings to send CSI u sequences (see alacritty.toml)
bind -n C-S-e split-window -h -c "#{pane_current_path}"
bind -n C-S-o split-window -v -c "#{pane_current_path}"

# Close pane (no prefix! Matches browser Ctrl+W "close tab")
# Requires Alacritty CSI u sequence (see alacritty.toml)
bind -n C-S-w confirm-before -p "Close pane? (y/n)" kill-pane

# Split panes with prefix (alternative)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# Navigate panes with Ctrl+Shift+Arrow (Terminator-style, no prefix!)
bind -n C-S-Left select-pane -L
bind -n C-S-Down select-pane -D
bind -n C-S-Up select-pane -U
bind -n C-S-Right select-pane -R

# Navigate panes with Alt+hjkl (vim-style alternative)
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# Resize panes with Ctrl+Alt+Arrow (no prefix!)
# Note: GNOME intercepts these by default for workspace switching.
# Fix: see docs/TMUX_LEARNING_GUIDE.md troubleshooting, or run:
#   gsettings set org.gnome.desktop.wm.keybindings switch-to-workspace-{up,down} "['<Super>Page_{Up,Down}']"
bind -n C-M-Left resize-pane -L 2
bind -n C-M-Down resize-pane -D 2
bind -n C-M-Up resize-pane -U 2
bind -n C-M-Right resize-pane -R 2

# Resize panes with Shift+HJKL (with prefix, larger steps)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Toggle pane zoom (no prefix!)
bind -n M-z resize-pane -Z

# Toggle pane zoom with prefix (alternative)
bind z resize-pane -Z

# Swap pane position with next/previous
bind > swap-pane -D
bind < swap-pane -U

# Reorder windows left/right (no prefix! Matches browser Ctrl+Shift+PageUp/Down)
bind -n C-S-PPage swap-window -t -1\; select-window -t -1
bind -n C-S-NPage swap-window -t +1\; select-window -t +1

# Reorder windows with prefix (alternative)
bind -r S-Left swap-window -t -1\; select-window -t -1
bind -r S-Right swap-window -t +1\; select-window -t +1

# Toggle synchronized panes (type in all panes at once)
bind S setw synchronize-panes \; display "Sync #{?pane_synchronized,ON,OFF}"

# ============================================================================
# Key Bindings - Window Management
# ============================================================================

# Create new window (no prefix! Matches browser Ctrl+T "new tab")
# Requires Alacritty CSI u sequence (see alacritty.toml)
bind -n C-S-t new-window -c "#{pane_current_path}"

# Create new window with prefix (alternative)
bind c new-window -c "#{pane_current_path}"

# Next/previous window (no prefix! Matches browser Ctrl+PageUp/Down)
bind -n C-PPage previous-window
bind -n C-NPage next-window

# Quick window switching with Alt+number (no prefix needed)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# Toggle last window/pane (quick back-and-forth)
bind Tab last-window
bind BSpace last-pane

# ============================================================================
# Key Bindings - Copy Mode (Vim-style)
# ============================================================================

# Use vim keybindings in copy mode
setw -g mode-keys vi

# Enter copy mode (vim mnemonic: v = visual mode)
bind v copy-mode

# Jump straight to search (enters copy mode + starts incremental search)
bind / copy-mode \; send-keys /

# Quick scroll back (enters copy mode and pages up in one keystroke)
bind -n M-PPage copy-mode \; send-keys -X page-up

# Vim-style selection and copying
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi r send-keys -X rectangle-toggle
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle

# Copy selection and stay in copy mode (for multi-copy workflows)
bind -T copy-mode-vi Y send-keys -X copy-selection

# Incremental search (highlights matches as you type, like Ctrl+F in browser)
bind -T copy-mode-vi / command-prompt -i -I "#{pane_search_string}" -T search -p "(search down)" { send-keys -X search-forward-incremental "%%" }
bind -T copy-mode-vi ? command-prompt -i -I "#{pane_search_string}" -T search -p "(search up)" { send-keys -X search-backward-incremental "%%" }

# Mouse drag-select copies to clipboard on release (via OSC 52)
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-selection-and-cancel

# Paste buffer (vim mnemonic: p = paste)
bind p paste-buffer

# ============================================================================
# Key Bindings - Session Management
# ============================================================================

# Reload config with Ctrl+s r
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# Detach with Ctrl+s d (default)
bind d detach-client

# Quick switch to last session
bind B switch-client -l

# ============================================================================
# Status Bar Configuration (Dark Theme)
# ============================================================================

# Status bar position and update interval
# Clock shows HH:MM so refreshing every second is wasteful; 15s balances
# activity indicator responsiveness with CPU efficiency
set -g status-position bottom
set -g status-interval 15

# Status bar colors (dark theme)
set -g status-style bg=colour235,fg=colour250

# Left side: session name in blue pill
set -g status-left-length 30
set -g status-left "#[fg=colour16,bg=colour39,bold] #S #[fg=colour39,bg=colour235] "

# Right side: hostname | path | time date
set -g status-right-length 80
set -g status-right '#[fg=colour238]#[fg=colour250,bg=colour238] #h | #(echo "#{pane_current_path}" | sed "s|$HOME|~|") | %H:%M %d-%b '

# Active window: blue tab with powerline arrows (pops at a glance)
setw -g window-status-current-format "#[fg=colour39,bg=colour235]#[fg=colour16,bg=colour39,bold] #I:#W#F #[fg=colour39,bg=colour235]"

# Inactive windows: subdued grey
setw -g window-status-format "#[fg=colour244] #I:#W#F "

# Activity in background windows: amber text
setw -g window-status-activity-style "fg=colour214,bg=colour235,none"

# Window status separator
set -g window-status-separator ""

# Pane border colors
set -g pane-border-style fg=colour238
set -g pane-active-border-style fg=colour39

# Message colors (when you press Ctrl+s :)
set -g message-style bg=colour235,fg=colour39

# ============================================================================
# Popup Windows (tmux 3.2+ floating overlays)
# ============================================================================
# Popups float over your current layout and disappear when the command exits.
# Perfect for quick tasks without disrupting your pane arrangement.

# Alt+g: Lazygit popup (prefix-free! lazygit is installed via mise)
bind -n M-g display-popup -E -w 90% -h 90% -d "#{pane_current_path}" "lazygit"

# Prefix+t: Quick popup shell in current directory (t = terminal)
bind t display-popup -E -w 80% -h 80% -d "#{pane_current_path}"

# Prefix+G: Quick git status overview (q to close, scrollable)
bind G display-popup -E -w 80% -h 60% -d "#{pane_current_path}" \
  "{ git -c color.status=always status; echo '---'; git log --color --oneline -10; } | less -R"

# Alt+o, Alt+s, Alt+w, Prefix+e: Handled by tmux-ferret plugin (see Plugins section)

# ============================================================================
# Additional Settings
# ============================================================================

# Set terminal title
set -g set-titles on
set -g set-titles-string "#S / #W"

# Activity monitoring
setw -g monitor-activity on
set -g visual-activity off

# Allow automatic renaming of windows
setw -g automatic-rename on

# ============================================================================
# Tips for Beginners
# ============================================================================
#
# Getting Started:
#   tmn mysession         Start a new named session
#   tma mysession         Attach to existing session
#   tml                   List all sessions
#   Ctrl+s d          Detach from session (keeps running!)
#
# Inside tmux (most operations are prefix-free!):
#   Ctrl+Shift+E          Split pane vertically
#   Ctrl+Shift+O          Split pane horizontally
#   Ctrl+Shift+W          Close pane (with confirmation)
#   Ctrl+Shift+T          New window (like browser new tab)
#   Ctrl+Shift+F          Thumbs: quick-copy hints (like Vimium)
#   Ctrl+Shift+Arrow      Navigate between panes
#   Ctrl+Alt+Arrow        Resize panes
#   Alt+z                 Zoom pane (toggle fullscreen)
#   Alt+PageUp            Scroll back (copy mode + page up)
#   Ctrl+PageUp/Down      Next/previous window
#   Ctrl+Shift+PageUp/Down  Reorder windows
#   Alt+1-9               Switch to window by number
#   Ctrl+s v          Enter copy mode (vim visual)
#   Ctrl+s /          Search (copy mode + search)
#   Ctrl+s ?          Show all keybindings
#
# Copy Mode:
#   Ctrl+s v          Enter copy mode (or Ctrl+s [)
#   v                     Start selection (vim-style)
#   Ctrl+V                Rectangle (block) selection
#   /                     Incremental search forward
#   y                     Copy selection and exit
#   Y                     Copy selection and stay in copy mode
#   o                     Open selected URL in browser (tmux-open)
#   Ctrl+s p          Paste (or Ctrl+s ])
#
# Popups (floating overlays):
#   Alt+o                 Fuzzy file finder (prefix-free!)
#   Alt+s                 Fuzzy content search (prefix-free!)
#   Alt+w                 Session picker (prefix-free!)
#   Alt+g                 Lazygit popup (prefix-free!)
#   Ctrl+s t          Quick popup terminal
#   Ctrl+s e          Fuzzy file finder (same as Alt+o)
#   Ctrl+s G          Git status overview
#
# Mouse Support:
#   - Click to select pane
#   - Drag border to resize
#   - Scroll wheel for history
#   - Double-click to select word
#   - Triple-click to select line
#
# Common Workflows:
#   See: examples/tmux-workflows.md
#   Run: help tmux (in zsh)
#
# ============================================================================

# ============================================================================
# Plugins (via TPM - Tmux Plugin Manager)
# ============================================================================
# Install: prefix + I (capital i)
# Update:  prefix + U
# Clean:   prefix + alt + u

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'fcsonline/tmux-thumbs'
set -g @plugin 'tmux-plugins/tmux-open'
# Local path until published to GitHub (then: 'ZviBaratz/tmux-ferret')
set -g @plugin 'ZviBaratz/tmux-ferret'

# Resurrect settings
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-vim 'session'
set -g @resurrect-strategy-nvim 'session'

# Continuum: auto-save resurrect sessions every 15 minutes
# Auto-restore disabled for faster startup (manually restore with Ctrl+s Ctrl+r)
set -g @continuum-restore 'off'
set -g @continuum-save-interval '15'

# Thumbs: press Ctrl+Shift+F or prefix+F to show letter hints on copyable text
# Like Vimium for the terminal â€” much faster than entering copy mode for quick grabs
#   lowercase hint letter = copy to clipboard
#   UPPERCASE hint letter = open with xdg-open (URLs open in browser, files in default app)
set -g @thumbs-key F
# Prefix-free thumbs activation (requires Alacritty CSI u sequence for Ctrl+Shift+F)
bind -n C-S-f thumbs-pick
set -g @thumbs-position off_left
set -g @thumbs-contrast 1
set -g @thumbs-command 'echo -n {} | tmux load-buffer -w - && tmux display-message "Copied: {}"'
set -g @thumbs-upcase-command 'setsid gio open {} >/dev/null 2>&1'
set -g @thumbs-hint-fg-color black
set -g @thumbs-hint-bg-color yellow
set -g @thumbs-highlight-fg-color cyan
set -g @thumbs-highlight-bg-color black
set -g @thumbs-select-fg-color black
set -g @thumbs-select-bg-color green

# Initialize TPM (MUST be at very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
