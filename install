#!/usr/bin/env bash

set -e

CONFIG="install.conf.yaml"
DOTBOT_DIR="dotbot"

DOTBOT_BIN="bin/dotbot"
BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

cd "${BASEDIR}"
git -C "${DOTBOT_DIR}" submodule sync --quiet --recursive
git submodule update --init --recursive "${DOTBOT_DIR}"

"${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" -c "${CONFIG}" "${@}"

# Check if mise tools are configured
if command -v mise &> /dev/null || [[ -x "$HOME/.local/bin/mise" ]]; then
    echo ""
    echo "==> Configuring mise CLI tools..."

    # Copy unified mise configuration from dotfiles
    if [[ -f "${BASEDIR}/.mise.toml" ]]; then
        mkdir -p "$HOME/.config/mise"

        # Only copy if no existing config, or if dotfiles version is different
        if [[ ! -f "$HOME/.config/mise/config.toml" ]]; then
            cp "${BASEDIR}/.mise.toml" "$HOME/.config/mise/config.toml"
            echo "    ✓ Installed unified mise configuration"
        elif ! diff -q "${BASEDIR}/.mise.toml" "$HOME/.config/mise/config.toml" &>/dev/null; then
            echo "    ℹ mise config exists and differs from dotfiles"
            echo "      To use dotfiles version: cp ~/.dotfiles/.mise.toml ~/.config/mise/config.toml"
        else
            echo "    ✓ mise config already synchronized"
        fi
    fi

    # Activate mise for current shell to make tools available immediately
    if command -v mise &> /dev/null; then
        eval "$(mise activate bash)" 2>/dev/null || eval "$(mise activate zsh)" 2>/dev/null || true
    elif [[ -x "$HOME/.local/bin/mise" ]]; then
        eval "$("$HOME/.local/bin/mise" activate bash)" 2>/dev/null || eval "$("$HOME/.local/bin/mise" activate zsh)" 2>/dev/null || true
    fi

    if [[ -f "$HOME/.config/mise/config.toml" ]]; then
        echo "    ✓ Installing/updating CLI tools..."

        if mise install &> /dev/null; then
            echo "    ✓ CLI tools installed/updated successfully"
            echo "    ℹ Tools available in current shell after activation"
        else
            echo "    ⚠ Some tools failed to install (check: mise doctor)"
        fi
    else
        echo "    ℹ No mise config at ~/.config/mise/config.toml"
        echo "      Using dotfiles: ~/.dotfiles/.mise.toml"
    fi
else
    echo ""
    echo "==> mise not installed"
    echo "    Install mise via dev-setup or: curl https://mise.run | sh"
fi
