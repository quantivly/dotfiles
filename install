#!/usr/bin/env bash

set -e

CONFIG="install.conf.yaml"
DOTBOT_DIR="dotbot"

DOTBOT_BIN="bin/dotbot"
BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

cd "${BASEDIR}"
git -C "${DOTBOT_DIR}" submodule sync --quiet --recursive
git submodule update --init --recursive "${DOTBOT_DIR}"

"${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" -c "${CONFIG}" "${@}"

# Check if mise tools are configured
if command -v mise &> /dev/null || [[ -x "$HOME/.local/bin/mise" ]]; then
    echo ""
    echo "==> Checking mise CLI tools..."

    # Activate mise for current shell to make tools available immediately
    if command -v mise &> /dev/null; then
        eval "$(mise activate bash)" 2>/dev/null || eval "$(mise activate zsh)" 2>/dev/null || true
    elif [[ -x "$HOME/.local/bin/mise" ]]; then
        eval "$($HOME/.local/bin/mise activate bash)" 2>/dev/null || eval "$($HOME/.local/bin/mise activate zsh)" 2>/dev/null || true
    fi

    if [[ -f "$HOME/.config/mise/config.toml" ]]; then
        echo "    ✓ mise config found"

        if mise install &> /dev/null; then
            echo "    ✓ CLI tools installed/updated"
            echo "    ℹ Tools available in current shell after activation"
        else
            echo "    ⚠ Some tools failed to install (check: mise doctor)"
        fi
    else
        echo "    ℹ No mise config at ~/.config/mise/config.toml"
        echo "      Create one to manage CLI tools (see examples/mise-config.toml)"
    fi
else
    echo ""
    echo "==> mise not installed"
    echo "    Install mise via dev-setup or: curl https://mise.run | sh"
fi
