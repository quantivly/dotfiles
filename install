#!/usr/bin/env bash

set -e

CONFIG="install.conf.yaml"
DOTBOT_DIR="dotbot"

DOTBOT_BIN="bin/dotbot"
BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

cd "${BASEDIR}"
git -C "${DOTBOT_DIR}" submodule sync --quiet --recursive
git submodule update --init --recursive "${DOTBOT_DIR}"

"${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" -c "${CONFIG}" "${@}"

# Check if mise tools are configured
if command -v mise &> /dev/null || [[ -x "$HOME/.local/bin/mise" ]]; then
    echo ""
    echo "==> Configuring mise CLI tools..."

    # Symlink unified mise configuration from dotfiles
    # Using symlink instead of copy to maintain single source of truth
    if [[ -f "${BASEDIR}/.mise.toml" ]]; then
        mkdir -p "$HOME/.config/mise"

        mise_config="$HOME/.config/mise/config.toml"
        dotfiles_mise="${BASEDIR}/.mise.toml"

        # Check if config.toml exists and is not a symlink
        if [[ -f "$mise_config" ]] && [[ ! -L "$mise_config" ]]; then
            # Existing file that's not a symlink
            if diff -q "$dotfiles_mise" "$mise_config" &>/dev/null; then
                # Files are identical, safe to replace with symlink
                rm "$mise_config"
                ln -s "$dotfiles_mise" "$mise_config"
                echo "    âœ“ Replaced mise config with symlink (files were identical)"
            else
                # Files differ - preserve user changes
                echo "    âš ï¸  mise config exists with local changes"
                echo "      Current: $mise_config"
                echo "      Dotfiles: $dotfiles_mise"
                echo "      Keeping your version (not replacing with symlink)"
                echo "      To use dotfiles version: rm $mise_config && ln -s $dotfiles_mise $mise_config"
            fi
        elif [[ -L "$mise_config" ]]; then
            # Already a symlink - check if broken or pointing elsewhere
            if [[ ! -e "$mise_config" ]]; then
                # Broken symlink (target doesn't exist)
                echo "    âš ï¸  Broken symlink detected, recreating..."
                ln -sf "$dotfiles_mise" "$mise_config"
                echo "    âœ“ Fixed broken symlink to dotfiles"
            else
                # Valid symlink - check target
                current_target=$(readlink "$mise_config")
                if [[ "$current_target" == "$dotfiles_mise" ]]; then
                    echo "    âœ“ mise config already symlinked to dotfiles"
                else
                    echo "    â„¹ mise config symlinked to: $current_target"
                    echo "      To use dotfiles version: ln -sf $dotfiles_mise $mise_config"
                fi
            fi
        else
            # No config exists yet, create symlink
            ln -s "$dotfiles_mise" "$mise_config"
            echo "    âœ“ Installed mise configuration (symlinked to dotfiles)"
        fi

        # Inform about local overrides
        echo "    â„¹ For personal tool overrides: create ~/.config/mise/config.local.toml"
    fi

    # Activate mise for current shell to make tools available immediately
    if command -v mise &> /dev/null; then
        if ! eval "$(mise activate bash 2>/dev/null)"; then
            if ! eval "$(mise activate zsh 2>/dev/null)"; then
                echo "    âš ï¸  Warning: mise activation failed. Tools may not be available."
                echo "       This is normal if mise hasn't been configured yet."
            fi
        fi
    elif [[ -x "$HOME/.local/bin/mise" ]]; then
        if ! eval "$("$HOME/.local/bin/mise" activate bash 2>/dev/null)"; then
            if ! eval "$("$HOME/.local/bin/mise" activate zsh 2>/dev/null)"; then
                echo "    âš ï¸  Warning: mise activation failed. Tools may not be available."
                echo "       Run: mise install"
            fi
        fi
    fi

    if [[ -f "$HOME/.config/mise/config.toml" ]] || [[ -L "$HOME/.config/mise/config.toml" ]]; then
        echo "    Installing/updating CLI tools..."

        # Capture mise install output for detailed error reporting
        if MISE_OUTPUT=$(mise install 2>&1); then
            # Show what was actually installed/updated if available
            if echo "$MISE_OUTPUT" | grep -qE "installing|updating|installed|âœ“"; then
                echo "    âœ“ CLI tools installed/updated:"
                echo "$MISE_OUTPUT" | grep -E "installing|updating|installed|âœ“" | sed 's/^/      /'
            else
                echo "    âœ“ All CLI tools already up to date"
            fi
            echo "    â„¹ Tools available in current shell after activation"
        else
            echo "    âš  Some tools failed to install"
            echo ""

            # Show specific failures
            if echo "$MISE_OUTPUT" | grep -qi "error\|fail"; then
                echo "    Failed installations:"
                echo "$MISE_OUTPUT" | grep -i "error\|fail" | sed 's/^/      â€¢ /'
                echo ""
            fi

            echo "    Troubleshooting:"
            echo "      â€¢ Check details: mise doctor"
            echo "      â€¢ Retry installation: mise install"
            echo "      â€¢ Check specific tool: mise install <tool>"
            echo ""

            # Verify critical tools are available
            missing_tools=()
            for tool in bat fd eza delta zoxide; do
                if ! command -v "$tool" &>/dev/null; then
                    missing_tools+=("$tool")
                fi
            done

            if [[ ${#missing_tools[@]} -gt 0 ]]; then
                echo "    âš  Critical tools missing: ${missing_tools[*]}"
                echo "      These are required for optimal shell experience"
            fi
        fi
    else
        echo "    â„¹ No mise config found"
        echo "      Expected: ~/.config/mise/config.toml (symlinked from dotfiles)"
        echo "      Dotfiles version: ~/.dotfiles/.mise.toml"
    fi
else
    echo ""
    echo "==> mise not installed"
    echo "    Install mise via dev-setup or: curl https://mise.run | sh"
fi

# Install pre-commit hooks with user consent
if [[ -f "${BASEDIR}/.pre-commit-config.yaml" ]]; then
    echo ""
    echo "==> Pre-commit hooks available"

    if command -v pre-commit &> /dev/null; then
        echo "    Pre-commit hooks run before each commit to:"
        echo "    â€¢ Check for security issues (gitleaks)"
        echo "    â€¢ Validate shell scripts (shellcheck)"
        echo "    â€¢ Format code consistently"
        echo ""
        echo "    Note: Hooks download dependencies from remote repositories"
        echo ""

        # Check if running in CI or non-interactive environment
        if [[ -t 0 ]] && [[ -z "${CI:-}" ]]; then
            # Interactive environment - ask for consent
            read -p "    Install pre-commit hooks? (Y/n): " -n 1 -r
            echo

            if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
                # Install hooks with --install-hooks to download hook dependencies
                echo "    Installing pre-commit hooks..."
                if pre-commit install --install-hooks 2>&1 | sed 's/^/      /'; then
                    echo "    âœ“ Pre-commit hooks installed successfully"
                    echo "    â„¹ Hooks will run automatically before each commit"
                else
                    echo "    âš  Pre-commit hook installation failed"
                    echo "      Manual installation: pre-commit install --install-hooks"
                fi
            else
                echo "    â„¹ Skipped pre-commit hooks installation"
                echo "      Install later with: pre-commit install --install-hooks"
            fi
        else
            # Non-interactive or CI - skip with message
            echo "    â„¹ Non-interactive environment detected"
            echo "      Skipping pre-commit hooks installation"
            echo "      Install later with: pre-commit install --install-hooks"
        fi
    else
        echo "    â„¹ pre-commit not found"
        echo "      Install via mise: mise use -g pre-commit@latest"
        echo "      Or install directly: pip install pre-commit"
    fi
fi

# Forgit installation (optional git + fzf integration)
echo ""
echo "ðŸ“¦ Setting up forgit (interactive git with fzf)..."
if [ -d "$HOME/.forgit" ]; then
    echo "    â„¹ Forgit already installed at ~/.forgit"
    # Check if it's a git repo and can be updated
    if [ -d "$HOME/.forgit/.git" ]; then
        echo "    ðŸ”„ Checking for updates..."
        if git -C "$HOME/.forgit" pull --quiet 2>/dev/null; then
            echo "    âœ“ Forgit updated to latest version"
        else
            echo "    âš  Could not update forgit (may need manual intervention)"
        fi
    fi
else
    echo "    ðŸ“¥ Installing forgit..."
    if git clone --quiet https://github.com/wfxr/forgit.git "$HOME/.forgit" 2>/dev/null; then
        echo "    âœ“ Forgit installed successfully"
        echo "    â„¹ Forgit provides fuzzy git commands: gfa, gfco, gfcf, gfstash, etc."
    else
        echo "    âš  Forgit installation failed (optional feature)"
        echo "      Manual installation: git clone https://github.com/wfxr/forgit.git ~/.forgit"
    fi
fi
