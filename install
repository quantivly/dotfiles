#!/usr/bin/env bash

set -e

CONFIG="install.conf.yaml"
DOTBOT_DIR="dotbot"

DOTBOT_BIN="bin/dotbot"
BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

cd "${BASEDIR}"
git -C "${DOTBOT_DIR}" submodule sync --quiet --recursive
git submodule update --init --recursive "${DOTBOT_DIR}"

"${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" -c "${CONFIG}" "${@}"

# Check if mise tools are configured
if command -v mise &> /dev/null || [[ -x "$HOME/.local/bin/mise" ]]; then
    echo ""
    echo "==> Configuring mise CLI tools..."

    # Copy unified mise configuration from dotfiles
    if [[ -f "${BASEDIR}/.mise.toml" ]]; then
        mkdir -p "$HOME/.config/mise"

        # Only copy if no existing config, or if dotfiles version is different
        if [[ ! -f "$HOME/.config/mise/config.toml" ]]; then
            cp "${BASEDIR}/.mise.toml" "$HOME/.config/mise/config.toml"
            echo "    âœ“ Installed unified mise configuration"
        elif ! diff -q "${BASEDIR}/.mise.toml" "$HOME/.config/mise/config.toml" &>/dev/null; then
            echo "    â„¹ mise config exists and differs from dotfiles"
            echo "      To use dotfiles version: cp ~/.dotfiles/.mise.toml ~/.config/mise/config.toml"
        else
            echo "    âœ“ mise config already synchronized"
        fi
    fi

    # Activate mise for current shell to make tools available immediately
    if command -v mise &> /dev/null; then
        if ! eval "$(mise activate bash 2>/dev/null)"; then
            if ! eval "$(mise activate zsh 2>/dev/null)"; then
                echo "    âš ï¸  Warning: mise activation failed. Tools may not be available."
                echo "       This is normal if mise hasn't been configured yet."
            fi
        fi
    elif [[ -x "$HOME/.local/bin/mise" ]]; then
        if ! eval "$("$HOME/.local/bin/mise" activate bash 2>/dev/null)"; then
            if ! eval "$("$HOME/.local/bin/mise" activate zsh 2>/dev/null)"; then
                echo "    âš ï¸  Warning: mise activation failed. Tools may not be available."
                echo "       Run: mise install"
            fi
        fi
    fi

    if [[ -f "$HOME/.config/mise/config.toml" ]]; then
        echo "    âœ“ Installing/updating CLI tools..."

        if mise install &> /dev/null; then
            echo "    âœ“ CLI tools installed/updated successfully"
            echo "    â„¹ Tools available in current shell after activation"
        else
            echo "    âš  Some tools failed to install (check: mise doctor)"
        fi
    else
        echo "    â„¹ No mise config at ~/.config/mise/config.toml"
        echo "      Using dotfiles: ~/.dotfiles/.mise.toml"
    fi
else
    echo ""
    echo "==> mise not installed"
    echo "    Install mise via dev-setup or: curl https://mise.run | sh"
fi

# Install pre-commit hooks automatically
if [[ -f "${BASEDIR}/.pre-commit-config.yaml" ]]; then
    echo ""
    echo "==> Installing pre-commit hooks..."

    if command -v pre-commit &> /dev/null; then
        # Install hooks with --install-hooks to download hook dependencies
        if pre-commit install --install-hooks &> /dev/null; then
            echo "    âœ“ Pre-commit hooks installed successfully"
            echo "    â„¹ Hooks will run automatically before each commit"
        else
            echo "    âš  Failed to install pre-commit hooks"
            echo "      Manual installation: pre-commit install --install-hooks"
        fi
    else
        echo "    â„¹ pre-commit not found"
        echo "      Install via mise: mise use -g pre-commit@latest"
        echo "      Or install directly: pip install pre-commit"
    fi
fi

# Forgit installation (optional git + fzf integration)
echo ""
echo "ðŸ“¦ Setting up forgit (interactive git with fzf)..."
if [ -d "$HOME/.forgit" ]; then
    echo "    â„¹ Forgit already installed at ~/.forgit"
    # Check if it's a git repo and can be updated
    if [ -d "$HOME/.forgit/.git" ]; then
        echo "    ðŸ”„ Checking for updates..."
        if git -C "$HOME/.forgit" pull --quiet 2>/dev/null; then
            echo "    âœ“ Forgit updated to latest version"
        else
            echo "    âš  Could not update forgit (may need manual intervention)"
        fi
    fi
else
    echo "    ðŸ“¥ Installing forgit..."
    if git clone --quiet https://github.com/wfxr/forgit.git "$HOME/.forgit" 2>/dev/null; then
        echo "    âœ“ Forgit installed successfully"
        echo "    â„¹ Forgit provides fuzzy git commands: gfa, gfco, gfcf, gfstash, etc."
    else
        echo "    âš  Forgit installation failed (optional feature)"
        echo "      Manual installation: git clone https://github.com/wfxr/forgit.git ~/.forgit"
    fi
fi
