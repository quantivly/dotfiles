#!/bin/bash
# Pre-commit hook: Check if GPG cache is primed before allowing commit
# This prevents hanging sessions when GPG signing is enabled but cache is not primed

# Check if git-check-gpg-cache exists
if ! command -v git-check-gpg-cache &> /dev/null; then
    # Script not found, allow commit to proceed
    exit 0
fi

# Check if GPG cache is primed
if ! git-check-gpg-cache; then
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âš ï¸  GPG Cache Not Primed"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "GPG commit signing is enabled, but your passphrase cache has expired."
    echo "This would cause the commit to hang waiting for credentials."
    echo ""
    echo "ğŸ’¡ First time seeing this?"
    echo "   Run 'gpg-prime' once per work session to cache your passphrase"
    echo "   for 8-24 hours. You'll only need to enter it once!"
    echo ""
    echo "To fix this:"
    echo "  gpg-prime              # Prime cache (recommended)"
    echo ""
    echo "To commit without signing this once:"
    echo "  git commit --no-gpg-sign"
    echo ""
    echo "Need help? See: ~/.dotfiles/examples/gpg-setup-guide.md"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    exit 1
fi

# Cache is primed, allow commit to proceed
exit 0
